<html><head><base href=".">
<style>
    @import url('https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap');

    :root {
        --primary-bg: #f5f5f5;
        --primary-bg-tint: #f0f4fc;
        --container-bg: white;
        --text-color: #333;
        --button-primary: #1a73e8;
        --button-hover: #1557b0;
        --button-secondary: #1a73e8;
        --border-color: #dadce0;
        --shadow-color: rgba(60,64,67,0.3);
        --button-primary-rgb: 26, 115, 232;  /* Blue */
    }

    [data-color="blue"] {
        --button-primary: #1a73e8;
        --button-hover: #1557b0;
        --button-secondary: #1a73e8;
        --primary-bg-tint: #f0f4fc;
    }

    [data-color="green"] {
        --button-primary: #0f9d58;
        --button-hover: #0b8043;
        --button-secondary: #0f9d58;
        --primary-bg-tint: #f0faf4;
        --button-primary-rgb: 15, 157, 88;
    }

    [data-color="purple"] {
        --button-primary: #9334e6;
        --button-hover: #7627c4;
        --button-secondary: #9334e6;
        --primary-bg-tint: #f7f0fc;
        --button-primary-rgb: 147, 52, 230;
    }

    [data-color="red"] {
        --button-primary: #ea4335;
        --button-hover: #d33828;
        --button-secondary: #ea4335;
        --primary-bg-tint: #fdf1f0;
        --button-primary-rgb: 234, 67, 53;
    }

    [data-color="pink"] {
        --button-primary: #e91e63;
        --button-hover: #c2185b;
        --button-secondary: #e91e63;
        --primary-bg-tint: #fce4ec;
        --button-primary-rgb: 233, 30, 99;
    }

    [data-theme="dark"] {
        --primary-bg: rgb(23, 33, 43);  /* New dark mode color */
        --container-bg: #292a2d;
        --text-color: #e8eaed;
        --border-color: #3c4043;
        --shadow-color: rgba(0,0,0,0.3);
        --button-primary: #1a1a1a;
        --button-hover: #2a2a2a;
        --button-secondary: #1a1a1a;
    }

    [data-theme="dark"][data-color="blue"] {
        --primary-bg: #1a1c20;
        --primary-bg-tint: #1a1d24;
        --button-primary: #134c96;
        --button-hover: #0e3872;
        --button-secondary: #134c96;
    }

    [data-theme="dark"][data-color="green"] {
        --primary-bg: #1a1c20;
        --primary-bg-tint: #1a211d;
        --button-primary: #0b7440;
        --button-hover: #085c32;
        --button-secondary: #0b7440;
    }

    [data-theme="dark"][data-color="purple"] {
        --primary-bg: #1a1c20;
        --primary-bg-tint: #1d1a24;
        --button-primary: #7022b7;
        --button-hover: #5a1b96;
        --button-secondary: #7022b7;
    }

    [data-theme="dark"][data-color="red"] {
        --primary-bg: #1a1c20;
        --primary-bg-tint: #211a1a;
        --button-primary: #b8352a;
        --button-hover: #962b22;
        --button-secondary: #b8352a;
    }

    [data-theme="dark"][data-color="pink"] {
        --primary-bg: #1a1c20;
        --primary-bg-tint: #211a1e;
        --button-primary: #c2185b;
        --button-hover: #880e4f;
        --button-secondary: #c2185b;
    }

    body {
        font-family: 'Google Sans', Arial, sans-serif;
        max-width: 800px;
        margin: 20px auto;
        padding: 20px;
        background-color: var(--primary-bg-tint);
        color: var(--text-color);
        transition: all 0.3s ease;
    }
    
    .container {
        background-color: var(--container-bg);
        padding: 20px;
        border-radius: 16px;
        box-shadow: 0 4px 6px var(--shadow-color);
        box-sizing: border-box;
    }
    
    .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .header h2 {
        margin: 0;
        color: var(--button-primary);
        font-family: 'Google Sans', Arial, sans-serif;
        font-weight: 500;
    }

    [data-theme="dark"] .header h2 {
        color: white !important;  /* Force white color in dark mode */
    }

    .settings-toggle {
        background: none;
        border: none;
        color: var(--text-color);
        padding: 8px;
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .settings-toggle:hover {
        background-color: var(--primary-bg-tint);
    }

    .settings-toggle::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: var(--button-primary);
        opacity: 0.08;
        border-radius: 50%;
        transform: scale(0);
        transition: transform 0.3s ease;
    }

    .settings-toggle:hover::before {
        transform: scale(1);
    }

    .settings-toggle svg {
        position: relative;
        z-index: 1;
    }

    .settings-popup {
        position: fixed;
        top: 0;
        right: -400px;
        width: 350px;
        height: 100vh;
        background-color: var(--container-bg);
        box-shadow: -2px 0 8px var(--shadow-color);
        transition: right 0.3s ease;
        z-index: 1000;
    }

    .settings-popup.active {
        right: 0;
    }

    .settings-content {
        padding: 20px;
    }

    .settings-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .settings-header h3 {
        margin: 0;
        font-family: 'Google Sans', Arial, sans-serif;
        font-weight: 500;
        color: var(--button-primary);
    }

    [data-theme="dark"] .settings-header h3,
    [data-theme="dark"] .settings-label,
    [data-theme="dark"] .file-history h4 {
        color: white !important;
    }

    .close-settings {
        background: none;
        border: none;
        color: var(--text-color);
        font-size: 24px;
        padding: 4px 8px;
        cursor: pointer;
    }

    .close-settings:hover {
        background: none;
        transform: none;
    }

    .settings-label {
        margin: 16px 0 8px 0;
        font-family: 'Google Sans', Arial, sans-serif;
        font-weight: 500;
        color: var(--button-primary);
    }

    .settings-body .theme-controls {
        flex-direction: column;
        align-items: flex-start;
    }

    .settings-body .color-picker {
        margin: 8px 0;
    }

    .theme-controls {
        display: flex;
        gap: 10px;
        align-items: center;
    }

    .color-picker {
        display: flex;
        gap: 5px;
        margin-right: 10px;
    }

    .color-option {
        width: 25px;
        height: 25px;
        border-radius: 50%;
        cursor: pointer;
        border: 2px solid transparent;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

    .color-option:hover {
        transform: scale(1.1);
    }

    .color-option.active {
        border-color: var(--text-color);
    }

    .color-blue { background-color: #1a73e8; }
    .color-green { background-color: #0f9d58; }
    .color-purple { background-color: #9334e6; }
    .color-red { background-color: #ea4335; }
    .color-pink { background-color: #e91e63; }

    .ripple {
        position: absolute;
        border-radius: 50%;
        background-color: rgba(255, 255, 255, 0.5);
        transform: scale(0);
        animation: ripple-effect 0.6s linear;
        pointer-events: none;
    }

    @keyframes ripple-effect {
        0% {
            transform: scale(0);
            opacity: 0.5;
        }
        100% {
            transform: scale(100);
            opacity: 0;
        }
    }

    .theme-toggle {
        border-radius: 50px;
        padding: 8px 16px;
        background-color: var(--button-secondary);
        color: white;
        border: none;
        cursor: pointer;
        transition: all 0.3s ease;
        font-family: 'Google Sans', Arial, sans-serif;
        width: 100%;
        justify-content: center;
        display: flex;
        margin: 8px 0;
    }
    
    textarea {
        width: 100%;
        box-sizing: border-box;
        height: 300px;
        margin: 10px 0;
        padding: 10px;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        resize: vertical;
        background-color: var(--container-bg);
        color: var(--text-color);
        line-height: 1.5;
        text-align: left;
        direction: ltr;
        font-family: monospace;
    }

    textarea::-webkit-scrollbar {
        width: 12px;
    }

    textarea::-webkit-scrollbar-track {
        background: var(--primary-bg);
        border-radius: 10px;
    }

    textarea::-webkit-scrollbar-thumb {
        background: var(--button-primary);
        border-radius: 10px;
        border: 3px solid var(--primary-bg);
    }

    textarea::-webkit-scrollbar-thumb:hover {
        background: var(--button-hover);
    }
    
    button {
        background-color: var(--button-primary);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        margin: 5px;
        transition: all 0.3s ease;
        font-family: 'Google Sans', Arial, sans-serif;
        position: relative;
        overflow: hidden; /* Add this to contain ripple effect */
    }
    
    button:hover {
        background-color: var(--button-hover);
        transform: translateY(-1px);
        box-shadow: 0 1px 2px rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
    }

    /* Add these styles for disabled buttons */
    button:disabled {
        background-color: rgba(var(--button-primary-rgb), 0.3);
        cursor: not-allowed;
        transform: none !important;
        box-shadow: none !important;
    }

    button:disabled:hover {
        background-color: rgba(var(--button-primary-rgb), 0.3);
        transform: none;
        box-shadow: none;
    }

    .stats {
        padding: 15px;
        background-color: var(--container-bg);
        border-radius: 12px;
        border: 1px solid var(--border-color);
    }

    .stats h3 {
        font-family: 'Google Sans', Arial, sans-serif;
        font-weight: 500;
        color: var(--button-primary);
        margin-top: 0;
    }

    .merchant-count, .total-templates {
        display: inline-flex;
        margin: 0;
        align-items: center;
        color: var(--text-color);
    }

    .merchant-stats {
        margin: 8px 0;
        padding: 10px 20px; /* Increased horizontal padding */
        background-color: rgba(var(--button-primary-rgb), 0.05);
        border: 1px solid var(--border-color);
        border-radius: 50px; /* Changed to 50px to make it pill-shaped */
        display: flex;
        align-items: center;
        justify-content: flex-start;
        font-size: 0.9em;
        transition: background-color 0.3s ease;
    }

    /* Add hover effect */
    .merchant-stats:hover {
        background-color: rgba(var(--button-primary-rgb), 0.08);
    }

    /* Add selected state when checkbox is checked */
    .merchant-stats:has(.merchant-checkbox:checked) {
        background-color: rgba(var(--button-primary-rgb), 0.12);
    }

    .merchant-stats:first-child {
        margin-top: 10px; /* Add this line */
    }

    .merchant-stats > div {
        display: flex;
        align-items: center;
        justify-content: flex-start; /* Changed from center to flex-start */
        width: 100%;
    }

    .merchant-stats span {
        text-align: left; /* Changed from center to left */
    }

    .merchant-actions {
        display: flex;
        gap: 10px;
    }

    .merchant-checkbox {
        accent-color: var(--button-primary);
        transform: scale(1.1);
        margin-right: 8px;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border: 2px solid var(--button-primary);
        border-radius: 50%;
        outline: none;
        cursor: pointer;
        position: relative;
        transition: all 0.2s ease;
    }

    .merchant-checkbox:checked {
        background-color: var(--button-primary);
    }

    .merchant-checkbox:checked::after {
        content: '';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 8px;
        height: 8px;
        background-color: white;
        border-radius: 50%;
    }

    .merchant-checkbox:hover {
        border-color: var(--button-hover);
    }

    .merchant-checkbox:checked:hover {
        background-color: var(--button-hover);
    }

    .bulk-actions {
        margin-top: 15px;
        margin-bottom: 20px; /* Add this line */
        display: flex;
        gap: 10px;
    }

    .total-templates {
        margin-bottom: 15px;
        font-weight: bold;
        color: var(--text-color);
    }

    .button-ripple {
        position: absolute;
        background: rgba(255, 255, 255, 0.7);
        border-radius: 50%;
        width: 100px;
        height: 100px;
        margin-top: -50px;
        margin-left: -50px;
        animation: ripple 0.5s linear forwards;
        pointer-events: none;
    }

    @keyframes ripple {
        0% {
            transform: scale(0);
            opacity: 0.5;
        }
        100% {
            transform: scale(4);
            opacity: 0;
        }
    }

    .button-counter-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .button-group {
        display: flex;
        gap: 10px;
    }

    .counter-pill {
        display: flex;
        align-items: center;
        gap: 15px;
        background-color: var(--primary-bg);
        padding: 8px 20px;
        border-radius: 50px;
    }

    .counter-pill p {
        margin: 0;
        font-size: 14px;
        font-weight: 500;
    }

    /* Add these styles for the file history section */
    .file-history {
        margin-top: 24px;
    }

    .file-history h4 {
        margin: 0 0 12px 0;
        font-family: 'Google Sans', Arial, sans-serif;
        font-weight: 500;
        color: var(--button-primary);
    }

    .file-list {
        max-height: 300px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 12px;
        background: var(--primary-bg);
    }

    .file-list:empty::after {
        content: 'No files yet';
        display: block;
        padding: 16px;
        text-align: center;
        color: var(--text-color);
        opacity: 0.7;
    }

    .file-item {
        display: flex;
        align-items: center;
        padding: 12px;
        border-bottom: 1px solid var(--border-color);
        cursor: grab; /* Added to show draggability */
        background: var(--container-bg);
        transition: background-color 0.2s ease;
    }

    .file-item:last-child {
        border-bottom: none;
    }

    .file-item:hover {
        background-color: rgba(var(--button-primary-rgb), 0.05);
    }

    .file-item.dragging {
        cursor: grabbing; /* Added to show dragging */
        opacity: 0.5;
        background-color: rgba(var(--button-primary-rgb), 0.08);
    }

    .file-item::before {
        content: 'â‹®â‹®';  /* Drag handle indicator */
        margin-right: 8px;
        color: var(--text-color);
        opacity: 0.5;
    }

    .file-item:hover::before {
        opacity: 0.8;
    }

    .file-item.dragging {
        opacity: 0.5;
        background-color: rgba(var(--button-primary-rgb), 0.08);
    }

    .file-item input[type="checkbox"] {
        margin-right: 12px;
        accent-color: var(--button-primary);
    }

    .file-item-name {
        flex-grow: 1;
        margin-right: 12px;
        color: var(--text-color);
    }

    .file-item-date {
        color: var(--text-color);
        opacity: 0.7;
        font-size: 0.9em;
    }

    .file-actions {
        margin-top: 12px;
        display: flex;
        gap: 8px;
    }
</style>
</head>
<body data-color="blue">
<div class="container">
    <div class="header">
        <h2>Template Counter &amp; Note Taker</h2>
        <button class="settings-toggle" onclick="toggleSettings(event)">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path>
            </svg>
        </button>
    </div>

    <div class="settings-popup" id="settingsPopup">
        <div class="settings-content">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-settings" onclick="toggleSettings()">Ã—</button>
            </div>
            <div class="settings-body">
                <div class="theme-controls">
                    <p class="settings-label">Theme Color</p>
                    <div class="color-picker">
                        <div class="color-option color-blue active" onclick="setColor('blue')" title="Blue"></div>
                        <div class="color-option color-green" onclick="setColor('green')" title="Green"></div>
                        <div class="color-option color-purple" onclick="setColor('purple')" title="Purple"></div>
                        <div class="color-option color-red" onclick="setColor('red')" title="Red"></div>
                        <div class="color-option color-pink" onclick="setColor('pink')" title="Pink"></div>
                    </div>
                    <p class="settings-label">Display Mode</p>
                    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ™ Dark Mode</button>
                </div>
                <div class="file-history">
                    <h4>Downloaded Files</h4>
                    <div class="file-list" id="fileList"></div>
                    <div class="file-actions">
                        <button onclick="deleteSelectedFiles()" id="deleteSelectedFiles" disabled="">Delete Selected</button>
                        <button onclick="telegramShare()" title="Share to Telegram">
                            <svg style="width: 16px; height: 16px; margin-right: 6px; vertical-align: text-bottom;" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M9.78,18.65L10.06,14.42L17.74,7.5C18.08,7.19 17.67,7.04 17.22,7.31L7.74,13.3L3.64,12C2.76,11.75 2.75,11.14 3.84,10.7L19.81,4.54C20.54,4.21 21.24,4.72 20.96,5.84L18.24,18.65C18.05,19.56 17.5,19.78 16.74,19.36L12.6,16.3L10.61,18.23C10.38,18.46 10.19,18.65 9.78,18.65Z"></path>
                            </svg>
                            Share to Telegram
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <textarea id="noteArea" placeholder="Enter your notes here..."></textarea>
    
    <div class="button-counter-container">
        <div class="button-group">
            <button onclick="addSeparator()">Add Separator</button>
            <button onclick="addSpacing()">Add Spacing</button>
            <button onclick="clearText()">Clear</button>
        </div>
        <div class="counter-pill">
            <p class="merchant-count">Merchants: <span id="merchantCount">0</span></p>
            <p class="total-templates">Cases: <span id="totalTemplates">0</span></p>
        </div>
    </div>
    
    <div class="stats">
        <div class="bulk-actions">
            <button onclick="downloadSelectedMerchants()" disabled="">Download Selected</button>
            <button onclick="clearSelectedMerchants()" disabled="">Clear Selected</button>
            <button onclick="selectAllMerchants()">Select All</button>
            <button onclick="downloadAllNotes()">Download All</button>
        </div>
        <div id="merchantList"></div>
    </div>
</div>

<script>
const template = `We've reviewed our removal orders and discovered some shipments whose delivery status is unclear. Could you please check on your end? We're unable to verify the tracking status. If they were lost in transit, could you kindly issue a reimbursement`;

let downloadedFiles = [];

function saveThemeSettings() {
    const body = document.body;
    const settings = {
        color: body.getAttribute('data-color') || 'blue',
        theme: body.getAttribute('data-theme') || 'light'
    };
    localStorage.setItem('themeSettings', JSON.stringify(settings));
}

function loadThemeSettings() {
    const saved = localStorage.getItem('themeSettings');
    if (saved) {
        const settings = JSON.parse(saved);
        // Apply color
        setColor(settings.color, false); // Add false parameter to prevent duplicate saves
        
        // Apply theme
        const body = document.body;
        const button = document.querySelector('.theme-toggle');
        if (settings.theme === 'dark') {
            body.setAttribute('data-theme', 'dark');
            button.textContent = 'â˜€ï¸ Light Mode';
        } else {
            body.removeAttribute('data-theme');
            button.textContent = 'ðŸŒ™ Dark Mode';
        }
    }
}

// Modify the setColor function to accept a save parameter
function setColor(color, save = true) {
    const colorButton = document.querySelector(`.color-${color}`);
    const ripple = document.createElement('div');
    ripple.className = 'ripple';
    
    const size = Math.max(window.innerWidth, window.innerHeight) * 2;
    
    const rect = colorButton.getBoundingClientRect();
    const x = (rect.width / 2) - (size / 2);
    const y = (rect.height / 2) - (size / 2);
    
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    
    colorButton.querySelectorAll('.ripple').forEach(oldRipple => oldRipple.remove());
    
    colorButton.appendChild(ripple);
    
    document.body.setAttribute('data-color', color);
    
    document.querySelectorAll('.color-option').forEach(option => {
        option.classList.remove('active');
        if (option.classList.contains(`color-${color}`)) {
            option.classList.add('active');
        }
    });
    
    setTimeout(() => {
        ripple.remove();
    }, 600);

    // Save theme settings if save parameter is true
    if (save) {
        saveThemeSettings();
    }
}

// Modify the toggleTheme function to save settings
function toggleTheme() {
    const body = document.body;
    const button = document.querySelector('.theme-toggle');
    if (body.getAttribute('data-theme') === 'dark') {
        body.removeAttribute('data-theme');
        button.textContent = 'ðŸŒ™ Dark Mode';
    } else {
        body.setAttribute('data-theme', 'dark');
        button.textContent = 'â˜€ï¸ Light Mode';
    }
    // Save theme settings
    saveThemeSettings();
}

function addSeparator() {
    const textarea = document.getElementById('noteArea');
    if (textarea.value && !textarea.value.endsWith('\n')) {
        textarea.value += '\n';
    }
    textarea.value += '-'.repeat(41) + '\n';  // Removed one \n to reduce spacing
}

function addSpacing() {
    const textarea = document.getElementById('noteArea');
    if (textarea.value && !textarea.value.endsWith('\n')) {
        textarea.value += '\n';
    }
    textarea.value += '\n';
    textarea.focus();
}

function clearText() {
    const textarea = document.getElementById('noteArea');
    textarea.value = '';
    countTemplates(); // Update the counters after clearing
}

function getFormattedDate() {
    const date = new Date();
    return `${(date.getMonth() + 1).toString().padStart(2, '0')}-${date.getDate().toString().padStart(2, '0')}`;
}

function selectAllMerchants() {
    const checkboxes = document.querySelectorAll('.merchant-checkbox');
    // Check if all checkboxes are currently checked
    const allChecked = Array.from(checkboxes).every(checkbox => checkbox.checked);
    
    // If all are checked, uncheck all. Otherwise, check all
    checkboxes.forEach(checkbox => checkbox.checked = !allChecked);
    
    updateSelectedCount();
}

function countTemplatesInText(text) {
    return (text.match(new RegExp(template.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g')) || []).length;
}

function countTemplates() {
    const textarea = document.getElementById('noteArea');
    const text = textarea.value;
    
    const merchants = {};
    const merchantRegex = /(\d+\s+[^\n]+)/g;
    
    const sections = text.split(/-{41}/);
    let totalTemplates = 0;
    
    sections.forEach(section => {
        const match = section.match(merchantRegex);
        if (match) {
            const merchantHeader = match[0];
            const templateCount = countTemplatesInText(section);
            if (templateCount > 0) {
                merchants[merchantHeader] = {
                    text: section.trim(),
                    count: templateCount
                };
                totalTemplates += templateCount;
            }
        }
    });

    document.getElementById('merchantCount').textContent = Object.keys(merchants).length;
    document.getElementById('totalTemplates').textContent = totalTemplates;
    
    const merchantList = document.getElementById('merchantList');
    merchantList.innerHTML = ''; // Updated line

    Object.entries(merchants).forEach(([merchant, data]) => {
        const merchantDiv = document.createElement('div');
        merchantDiv.className = 'merchant-stats';
        merchantDiv.innerHTML = `
            <div>
                <input type="checkbox" class="merchant-checkbox" data-merchant="${merchant}" data-count="${data.count}" onchange="updateSelectedCount()">
                <span>${merchant}: ${data.count} case(s)</span>
            </div>
        `;
        merchantList.appendChild(merchantDiv);
    });

    // Add this line at the end of the function
    updateSelectedCount();
}

function updateSelectedCount() {
    const selectedCheckboxes = document.querySelectorAll('.merchant-checkbox:checked');
    let selectedTemplateCount = 0;
    
    selectedCheckboxes.forEach(checkbox => {
        selectedTemplateCount += parseInt(checkbox.dataset.count) || 0;
    });
    
    // Get the buttons
    const downloadSelectedButton = document.querySelector('button[onclick="downloadSelectedMerchants()"]');
    const clearSelectedButton = document.querySelector('button[onclick="clearSelectedMerchants()"]');
    
    // Enable/disable buttons based on selection
    if (selectedCheckboxes.length === 0) {
        downloadSelectedButton.disabled = true;
        clearSelectedButton.disabled = true;
    } else {
        downloadSelectedButton.disabled = false;
        clearSelectedButton.disabled = false;
    }
    
    document.getElementById('totalTemplates').textContent = selectedTemplateCount || countTemplatesInText(document.getElementById('noteArea').value);
}

function downloadSelectedMerchants() {
    const checkboxes = document.querySelectorAll('.merchant-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one merchant');
        return;
    }

    let selectedText = '';
    let totalTemplates = 0;
    checkboxes.forEach(checkbox => {
        const merchantHeader = checkbox.dataset.merchant;
        const section = document.getElementById('noteArea').value.split(/-{41}/)
            .find(section => section.includes(merchantHeader));
        if (section) {
            selectedText += section.trim() + '\n\n' + '-'.repeat(41) + '\n\n';
            totalTemplates += countTemplatesInText(section);
        }
    });

    const filename = `3COUTB_${getFormattedDate()}_(${totalTemplates})_.txt`;
    downloadText(selectedText.trim(), filename);
}

function clearSelectedMerchants() {
    const checkboxes = document.querySelectorAll('.merchant-checkbox:checked');
    if (checkboxes.length === 0) {
        alert('Please select at least one merchant');
        return;
    }

    const textarea = document.getElementById('noteArea');
    let text = textarea.value;

    checkboxes.forEach(checkbox => {
        const merchantHeader = checkbox.dataset.merchant;
        const sections = text.split(/-{41}/);
        text = sections.filter(section => !section.includes(merchantHeader)).join('-'.repeat(41));
    });

    textarea.value = text.trim();
    countTemplates();
}

function downloadAllNotes() {
    const textarea = document.getElementById('noteArea');
    const totalTemplates = countTemplatesInText(textarea.value);
    const filename = `3COUTB_${getFormattedDate()}_(${totalTemplates})_.txt`;
    downloadText(textarea.value, filename);
}

function downloadText(text, filename) {
    const blob = new Blob([text], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
    
    // Add to file history
    addToFileHistory(filename, text);
}

function toggleSettings(e) {
    if (e) {
        e.stopPropagation();
    }
    const popup = document.getElementById('settingsPopup');
    popup.classList.toggle('active');
}

document.addEventListener('click', function(e) {
    const settingsPopup = document.getElementById('settingsPopup');
    const settingsToggle = document.querySelector('.settings-toggle');
    
    if (!settingsPopup.contains(e.target) && !settingsToggle.contains(e.target)) {
        settingsPopup.classList.remove('active');
    }
});

document.getElementById('noteArea').addEventListener('input', countTemplates);
document.getElementById('noteArea').addEventListener('paste', (e) => {
    setTimeout(() => {
        const textarea = e.target;
        if (textarea.value && !textarea.value.endsWith('\n')) {
            textarea.value += '\n';
        }
    }, 0);
});

// Add this function to handle ripple effect
function createRipple(event) {
    const button = event.currentTarget;
    
    // Remove existing ripples
    const ripples = button.getElementsByClassName('button-ripple');
    for (let ripple of ripples) {
        ripple.remove();
    }

    const circle = document.createElement('span');
    const diameter = Math.max(button.clientWidth, button.clientHeight);
    
    circle.style.width = circle.style.height = `${diameter}px`;
    circle.className = 'button-ripple';
    
    const rect = button.getBoundingClientRect();
    circle.style.left = `${event.clientX - rect.left}px`;
    circle.style.top = `${event.clientY - rect.top}px`;
    
    button.appendChild(circle);
    
    // Remove ripple after animation
    setTimeout(() => {
        circle.remove();
    }, 500);
}

// Add click event listeners to all buttons
document.querySelectorAll('button').forEach(button => {
    button.addEventListener('click', createRipple);
});

// Functions to manage the file history
function addToFileHistory(filename, content) {
    const file = {
        id: Date.now(),
        name: filename,
        content: content,
        date: new Date().toLocaleString(),
    };
    downloadedFiles.unshift(file);
    updateFileList();
    saveFileHistory();
}

function updateFileList() {
    const fileList = document.getElementById('fileList');
    if (!fileList) return;
    
    fileList.innerHTML = '';
    downloadedFiles.forEach(file => {
        const fileItem = document.createElement('div');
        fileItem.className = 'file-item';
        fileItem.draggable = true;
        fileItem.dataset.fileId = file.id;
        fileItem.innerHTML = `
            <input type="checkbox" onchange="updateFileSelections()">
            <span class="file-item-name">${file.name}</span>
            <span class="file-item-date">${file.date}</span>
        `;

        // Add drag and drop event listeners
        fileItem.addEventListener('dragstart', handleDragStart);
        fileItem.addEventListener('dragend', handleDragEnd);
        
        fileList.appendChild(fileItem);
    });
}

function handleDragStart(e) {
    this.classList.add('dragging');
    const fileId = this.dataset.fileId;
    const file = downloadedFiles.find(f => f.id === parseInt(fileId));
    
    // Create an actual file object for the drag operation
    const blob = new Blob([file.content], { type: 'text/plain' });
    const fileObj = new File([blob], file.name, { type: 'text/plain' });
    
    // Set up the drag data transfer with both the file and fallback text
    e.dataTransfer.setData('text/plain', file.content);
    e.dataTransfer.setData('DownloadURL', `text/plain:${file.name}:${URL.createObjectURL(blob)}`);
    
    // Add the file to dataTransfer.items and .files
    e.dataTransfer.items.add(fileObj);
    e.dataTransfer.effectAllowed = 'copy';
}

function handleDragEnd() {
    this.classList.remove('dragging');
}

function updateFileSelections() {
    const selectedFiles = document.querySelectorAll('#fileList input[type="checkbox"]:checked').length;
    document.getElementById('deleteSelectedFiles').disabled = selectedFiles === 0;
}

function deleteSelectedFiles() {
    const fileItems = document.querySelectorAll('#fileList .file-item');
    fileItems.forEach(item => {
        if (item.querySelector('input[type="checkbox"]').checked) {
            const fileId = parseInt(item.dataset.fileId);
            downloadedFiles = downloadedFiles.filter(f => f.id !== fileId);
        }
    });
    updateFileList();
    saveFileHistory();
    updateFileSelections();
}

function saveFileHistory() {
    localStorage.setItem('downloadedFiles', JSON.stringify(downloadedFiles));
}

function loadFileHistory() {
    const saved = localStorage.getItem('downloadedFiles');
    if (saved) {
        downloadedFiles = JSON.parse(saved);
        updateFileList();
    }
}

// Add the telegramShare function
function telegramShare() {
    // Get selected files or current text
    const selectedFiles = document.querySelectorAll('#fileList input[type="checkbox"]:checked');
    let textToShare = '';

    if (selectedFiles.length > 0) {
        // Share selected files from history
        selectedFiles.forEach(checkbox => {
            const fileItem = checkbox.closest('.file-item');
            const fileId = parseInt(fileItem.dataset.fileId);
            const file = downloadedFiles.find(f => f.id === fileId);
            if (file) {
                textToShare += `${file.name}\n${file.content}\n\n`;
            }
        });
    } else {
        // Share current textarea content if no files selected
        const textarea = document.getElementById('noteArea');
        const totalTemplates = countTemplatesInText(textarea.value);
        const filename = `3COUTB_${getFormattedDate()}_(${totalTemplates})_.txt`;
        textToShare = `${filename}\n${textarea.value}`;
    }

    // Encode the text for the URL
    const encodedText = encodeURIComponent(textToShare);
    
    // Create Telegram share URL
    const telegramUrl = `tg://msg?text=${encodedText}`;

    // Try to open Telegram desktop app
    window.location.href = telegramUrl;

    // Fallback to web version if desktop app is not installed
    setTimeout(() => {
        const webUrl = `https://t.me/share/url?url=&text=${encodedText}`;
        window.open(webUrl, '_blank');
    }, 500);
}

// Initialize file history when the page loads
document.addEventListener('DOMContentLoaded', function() {
    loadFileHistory();
    loadThemeSettings(); // Add this line to load theme settings on page load
});
</script>
</body></html>
